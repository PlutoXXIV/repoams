#!/usr/bin/env python3
"""
Navigation Phase Launch File

This launch file starts components needed for autonomous navigation between
detected waypoints using A* pathfinding after exploration is complete.

WHAT THIS LAUNCHES:
1. Hardware drivers (LIDAR, IMU, motor control)
2. Robot state publishing (URDF â†’ TF tree)
3. Sensor fusion (EKF)
4. Map server (loads saved map from exploration)
5. Localization (AMCL - robot localization on known map)
6. Navigation stack (for A* path planning and execution)
7. Position identifier (detects current waypoint)
8. A* navigator (plans and executes path to goal)

NOT INCLUDED (Exploration phase only):
- SLAM (map already created)
- M-Explore (exploration already done)
- Waypoint detector (waypoints already found and saved)

USE CASE:
Second phase of operation - robot uses saved map to navigate from one
waypoint to another using optimal A* pathfinding.

PREREQUISITES:
1. Exploration phase completed
2. Map saved to maps/maze_map.yaml and maps/maze_map.pgm
3. Waypoints saved to ~/.ros/maze_waypoints.yaml
4. Robot manually positioned at one of the waypoints

USAGE:
    ros2 launch maze_explorer navigation.launch.py map_file:=/path/to/map.yaml

PARAMETERS:
    map_file: Path to saved map file (default: package maps/maze_map.yaml)
    use_sim_time: Use simulation time (default: false)

Save this file as: ~/maze_robot_ws/src/maze_explorer/launch/navigation.launch.py
"""

import os
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, IncludeLaunchDescription, TimerAction
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node

def generate_launch_description():
    """
    Generate launch description for navigation phase.
    """
    
    # =========================================================================
    # PACKAGE DIRECTORIES
    # =========================================================================
    
    pkg_maze_explorer = get_package_share_directory('maze_explorer')
    
    # =========================================================================
    # LAUNCH ARGUMENTS
    # =========================================================================
    
    use_sim_time_arg = DeclareLaunchArgument(
        'use_sim_time',
        default_value='false',
        description='Use simulation time if true'
    )
    
    # Map file argument (user can specify custom map location)
    map_file_arg = DeclareLaunchArgument(
        'map_file',
        default_value=os.path.join(pkg_maze_explorer, 'maps', 'maze_map.yaml'),
        description='Full path to map YAML file'
    )
    
    # =========================================================================
    # CONFIGURATION FILE PATHS
    # =========================================================================
    
    nav2_params_file = os.path.join(pkg_maze_explorer, 'config', 'nav2_params.yaml')
    ekf_params_file = os.path.join(pkg_maze_explorer, 'config', 'ekf_params.yaml')
    controllers_file = os.path.join(pkg_maze_explorer, 'config', 'controllers.yaml')
    
    urdf_file = os.path.join(pkg_maze_explorer, 'urdf', 'maze_robot.urdf.xacro')
    
    # =========================================================================
    # HARDWARE DRIVERS
    # =========================================================================
    
    # LIDAR Driver
    lidar_node = Node(
        package='sllidar_ros2',
        executable='sllidar_node',
        name='sllidar_node',
        output='screen',
        parameters=[{
            'channel_type': 'serial',
            'serial_port': '/dev/ttyUSB0',
            'serial_baudrate': 115200,
            'frame_id': 'lidar_link',
            'inverted': False,
            'angle_compensate': True,
        }]
    )
    
    # IMU Driver
    imu_node = Node(
        package='bno08x_ros2_driver',
        executable='bno08x_ros2_driver_node',
        name='bno08x_imu',
        output='screen',
        parameters=[{
            'i2c_bus': 1,
            'i2c_address': 0x4A,
            'frame_id': 'imu_link',
            'publish_rate': 50.0,
        }]
    )
    
    # =========================================================================
    # ROBOT DESCRIPTION AND STATE PUBLISHING
    # =========================================================================
    
    # Robot State Publisher
    robot_state_publisher = Node(
        package='robot_state_publisher',
        executable='robot_state_publisher',
        name='robot_state_publisher',
        output='screen',
        parameters=[{
            'robot_description': open(urdf_file).read(),
            'use_sim_time': LaunchConfiguration('use_sim_time')
        }]
    )
    
    # =========================================================================
    # ROS2_CONTROL - MOTOR CONTROL
    # =========================================================================
    
    # Controller Manager
    controller_manager = Node(
        package='controller_manager',
        executable='ros2_control_node',
        output='screen',
        parameters=[
            {'robot_description': open(urdf_file).read()},
            controllers_file,
            {'use_sim_time': LaunchConfiguration('use_sim_time')}
        ]
    )
    
    # Joint State Broadcaster (with delay)
    joint_state_broadcaster_spawner = TimerAction(
        period=2.0,
        actions=[
            Node(
                package='controller_manager',
                executable='spawner',
                arguments=['joint_state_broadcaster'],
                output='screen'
            )
        ]
    )
    
    # Mecanum Drive Controller (with delay)
    mecanum_controller_spawner = TimerAction(
        period=3.0,
        actions=[
            Node(
                package='controller_manager',
                executable='spawner',
                arguments=['mecanum_drive_controller'],
                output='screen'
            )
        ]
    )
    
    # =========================================================================
    # SENSOR FUSION
    # =========================================================================
    
    # Extended Kalman Filter
    ekf_node = Node(
        package='robot_localization',
        executable='ekf_node',
        name='ekf_filter_node',
        output='screen',
        parameters=[ekf_params_file, {
            'use_sim_time': LaunchConfiguration('use_sim_time')
        }]
    )
    
    # =========================================================================
    # MAP SERVER - LOAD SAVED MAP
    # =========================================================================
    
    # Map Server (loads the map created during exploration)
    map_server_node = Node(
        package='nav2_map_server',
        executable='map_server',
        name='map_server',
        output='screen',
        parameters=[{
            'yaml_filename': LaunchConfiguration('map_file'),
            'use_sim_time': LaunchConfiguration('use_sim_time')
        }]
    )
    
    # Lifecycle manager for map server
    map_lifecycle_manager = Node(
        package='nav2_lifecycle_manager',
        executable='lifecycle_manager',
        name='map_lifecycle_manager',
        output='screen',
        parameters=[{
            'autostart': True,
            'node_names': ['map_server'],
            'use_sim_time': LaunchConfiguration('use_sim_time')
        }]
    )
    
    # =========================================================================
    # LOCALIZATION - AMCL
    # =========================================================================
    
    # AMCL (Adaptive Monte Carlo Localization)
    # Estimates robot's position on the known map
    amcl_node = Node(
        package='nav2_amcl',
        executable='amcl',
        name='amcl',
        output='screen',
        parameters=[{
            'use_sim_time': LaunchConfiguration('use_sim_time'),
            'alpha1': 0.2,  # Rotation noise from rotation
            'alpha2': 0.2,  # Rotation noise from translation
            'alpha3': 0.2,  # Translation noise from translation
            'alpha4': 0.2,  # Translation noise from rotation
            'base_frame_id': 'base_footprint',
            'beam_skip_distance': 0.5,
            'beam_skip_error_threshold': 0.9,
            'beam_skip_threshold': 0.3,
            'do_beamskip': False,
            'global_frame_id': 'map',
            'lambda_short': 0.1,
            'laser_likelihood_max_dist': 2.0,
            'laser_max_range': 12.0,
            'laser_min_range': 0.15,
            'laser_model_type': 'likelihood_field',
            'max_beams': 60,
            'max_particles': 2000,
            'min_particles': 500,
            'odom_frame_id': 'odom',
            'pf_err': 0.05,
            'pf_z': 0.99,
            'recovery_alpha_fast': 0.0,
            'recovery_alpha_slow': 0.0,
            'resample_interval': 1,
            'robot_model_type': 'nav2_amcl::DifferentialMotionModel',
            'save_pose_rate': 0.5,
            'sigma_hit': 0.2,
            'tf_broadcast': True,
            'transform_tolerance': 1.0,
            'update_min_a': 0.2,
            'update_min_d': 0.25,
            'z_hit': 0.5,
            'z_max': 0.05,
            'z_rand': 0.5,
            'z_short': 0.05,
            'scan_topic': '/scan',
            'map_topic': '/map',
            'set_initial_pose': False,  # Robot starts at unknown position
            'always_reset_initial_pose': False,
        }]
    )
    
    # =========================================================================
    # NAVIGATION STACK
    # =========================================================================
    
    # NAV2 Navigation Stack (uses A* planner)
    nav2_bringup_dir = get_package_share_directory('nav2_bringup')
    nav2_launch = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(nav2_bringup_dir, 'launch', 'navigation_launch.py')
        ),
        launch_arguments={
            'use_sim_time': LaunchConfiguration('use_sim_time'),
            'params_file': nav2_params_file,
            'autostart': 'true'
        }.items()
    )
    
    # =========================================================================
    # CUSTOM APPLICATION NODES - NAVIGATION SPECIFIC
    # =========================================================================
    
    # Position Identifier (detects which waypoint robot is at)
    position_identifier = Node(
        package='maze_explorer',
        executable='position_identifier.py',
        name='position_identifier',
        output='screen',
        parameters=[{
            'use_sim_time': LaunchConfiguration('use_sim_time')
        }]
    )
    
    # A* Navigator (plans and executes optimal path)
    astar_navigator = Node(
        package='maze_explorer',
        executable='astar_navigator.py',
        name='astar_navigator',
        output='screen',
        parameters=[{
            'use_sim_time': LaunchConfiguration('use_sim_time')
        }]
    )
    
    # =========================================================================
    # HELPER NODE - INITIAL POSE ESTIMATOR
    # =========================================================================
    
    # This node helps AMCL by providing an initial pose estimate
    # when robot is placed at a waypoint
    initial_pose_publisher = Node(
        package='maze_explorer',
        executable='initial_pose_helper.py',
        name='initial_pose_helper',
        output='screen',
        parameters=[{
            'use_sim_time': LaunchConfiguration('use_sim_time')
        }],
        # Only if you create this helper script (optional)
        # Otherwise, AMCL will localize naturally after a few movements
        condition=None  # Remove this node if script not created
    )
    
    # =========================================================================
    # BUILD LAUNCH DESCRIPTION
    # =========================================================================
    
    return LaunchDescription([
        # Launch arguments
        use_sim_time_arg,
        map_file_arg,
        
        # Hardware drivers
        lidar_node,
        imu_node,
        
        # Robot description and state
        robot_state_publisher,
        
        # Motor control (ros2_control)
        controller_manager,
        joint_state_broadcaster_spawner,
        mecanum_controller_spawner,
        
        # Sensor fusion
        ekf_node,
        
        # Map server
        map_server_node,
        map_lifecycle_manager,
        
        # Localization
        amcl_node,
        
        # Navigation
        nav2_launch,
        
        # Custom navigation nodes
        position_identifier,
        astar_navigator,
        
        # Helper (optional - comment out if not created)
        # initial_pose_publisher,
    ])

